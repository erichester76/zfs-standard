---
- name: ZFS Configuration
  hosts: zfs_server
  become: yes
  vars_files:
    - vars/main.yml
  vars: 
    encrypted_devices: "{{ multipath_devices | map('basename') | map('regex_replace', '^', 'encrypted_') | list }}"
    
  tasks:
    - name: Validate disk count
      assert:
        that:
          - disks | length >= total_disks_for_vdevs + spare_count
        fail_msg: "Insufficient disks: {{ disks | length }} provided, but {{ total_disks_for_vdevs + spare_count }} required."

   # Set I/O scheduler to noop for ZFS disks
    - name: Set I/O scheduler to noop for ZFS disks
      shell: |
        for disk in {{ disks | map('basename') | join(' ') }}; do
          echo noop > /sys/block/$disk/queue/scheduler
        done
      when: disks is defined

    # Make the scheduler change persistent
    - name: Make I/O scheduler change persistent
      lineinfile:
        path: /etc/rc.local
        line: "echo noop > /sys/block/{{ item | basename }}/queue/scheduler"
        create: yes
        mode: '0755'
      loop: "{{ disks }}"
      when: disks is defined

    - name: Create ZFS pool with encrypted multipath devices
      command: >
        zpool create -f -o ashift=12 {{ zpool_name }}
        {% for vdev in range(0, total_disks_for_vdevs, disks_per_vdev) %}
        raidz2 {{ encrypted_devices[vdev:vdev + disks_per_vdev] | map('regex_replace', '^', '/dev/mapper/') | join(' ') }}
        {% endfor %}
        spare {{ encrypted_devices[total_disks_for_vdevs:total_disks_for_vdevs + spare_count] | map('regex_replace', '^', '/dev/mapper/') | join(' ') }}
      args:
        creates: /{{ zpool_name }}

    - name: Create ZFS dataset
      zfs:
        name: "{{ zfs_dataset }}"
        state: present
        extra_zfs_properties:
          recordsize: 64K
          compression: lz4
          atime: off

    # Ensure rc.local is executable
    - name: Ensure rc.local is executable
      file:
        path: /etc/rc.local
        mode: '0755'